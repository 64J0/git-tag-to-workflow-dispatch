name: 'Git Tags to Workflow Dispatch'
description: 'Automatically populate the workflow options with available tags from the repo'
author: '64J0'
inputs:
  values-to-take:
    description: >
      In order to avoid presenting very old tags at the workflow options, this input let's you
      specify how many tags to take, considering the order starting from the new tags to the
      old tags. If you don't specify this value, it will take all the tags.
    default: '-1'
  workflow-file-name:
    description: >
      Specify the target workflow file name that must live under `.github/workflows/`.
  workflow-yaml-key:
    description: >
      Specify the workflow YAML key that will be updated.
  pull-request:
    description: >
      TODO. Set the value 'false' if you prefer that the workflow change is commited directly
      instead of creating a pull request that you can manually verify.
    default: 'true'
  github-token:
    description: >
      A GitHub token with permissions:
      - contents: write
      - pull-requests: write
      Necessary for https://github.com/marketplace/actions/create-pull-request#action-inputs.
      Also necessary: https://github.com/marketplace/actions/create-pull-request#workflow-permissions.
  base-branch:
    description: >
      Specify the pull request base branch.
    default: 'main'
runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # to get the tags
    - name: Try to get the tags
      shell: bash
      run: |
        THIS_GIT_TAGS=$(git tag --sort -creatordate --column)

        echo "Git tags: ${THIS_GIT_TAGS}"

        echo "THIS_GIT_TAGS=${THIS_GIT_TAGS}" >> "${GITHUB_ENV}"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
    - name: Run the .NET program
      shell: bash
      env:
        VALUES_TO_TAKE: ${{ inputs.values-to-take }}
        WORKFLOW_FILE_NAME: ${{ inputs.workflow-file-name }}
        WORKFLOW_KEY: ${{ inputs.workflow-yaml-key }}
        REPO_PATH: ${{ inputs.repo_path }}
        GIT_TAGS: ${{ env.THIS_GIT_TAGS }}
      run: dotnet run --project src/ "${GIT_TAGS}"
    
    - name: Merge the workflows
      uses: mikefarah/yq@master
      env:
        WORKFLOW_FILE_NAME: ${{ inputs.workflow-file-name }}
      with:
        cmd: yq -i '. * load("./src/workflow.new.yml")' ".github/workflows/${WORKFLOW_FILE_NAME}"
    
    - name: Create pull request
      # if: ${{ inputs.pull-request }} # TODO
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ inputs.github-token }}
        branch-suffix: timestamp
        branch: git-tag-to-workflow-dispatch
        commit-message: |
          chore: automated git tags to workflow dispatch

          this commit is updating the workflow dispatch (github actions) options autonomously
          with the tags from this repository